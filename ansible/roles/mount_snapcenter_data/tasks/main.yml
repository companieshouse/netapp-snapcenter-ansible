---
- name: Wait for EBS volume device to be available
  ansible.builtin.wait_for:
    path: "{{ mount_snapcenter_data_device_name }}"
    state: present
    timeout: 300

- name: Check if device is already formatted
  ansible.builtin.command: blkid -o value -s TYPE {{ mount_snapcenter_data_device_name }}
  register: mount_snapcenter_data_device_fstype
  failed_when: false
  changed_when: false

- name: Create filesystem on EBS volume
  community.general.filesystem:
    fstype: "{{ mount_snapcenter_data_filesystem_type }}"
    dev: "{{ mount_snapcenter_data_device_name }}"
  when: mount_snapcenter_data_device_fstype.stdout == ""

- name: Ensure mount point directory exists
  ansible.builtin.file:
    path: "{{ mount_snapcenter_data_mount_point }}"
    state: directory
    mode: '0755'

- name: Mount EBS volume
  ansible.posix.mount:
    path: "{{ mount_snapcenter_data_mount_point }}"
    src: "{{ mount_snapcenter_data_device_name }}"
    fstype: "{{ mount_snapcenter_data_filesystem_type }}"
    state: mounted
    opts: defaults,nofail

- name: Set correct ownership on mount point
  ansible.builtin.file:
    path: "{{ mount_snapcenter_data_mount_point }}"
    owner: root
    group: root
    mode: '0755'

- name: Grow XFS filesystem to use full volume size
  ansible.builtin.command: xfs_growfs {{ mount_snapcenter_data_mount_point }}
  when: mount_snapcenter_data_filesystem_type == "xfs"
  register: mount_snapcenter_data_growfs_result
  changed_when: "'data blocks changed' in mount_snapcenter_data_growfs_result.stdout"
  failed_when:
    - mount_snapcenter_data_growfs_result.rc != 0
    - "'data blocks unchanged' not in mount_snapcenter_data_growfs_result.stdout"
